name: Kubernetes FIPS

on:
  schedule:
    # Run at 2:00 UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering
    inputs:
      page:
        description: The page number to fetch
        default: "1"
        type: string
      per_page:
        description: The number of releases per page
        default: "50"
        type: string
      force:
        description: Force the build even if the release already exists
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      kubernetes_minor_version:
        description: The minimum minor version of Kubernetes to build
        type: string

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.get-releases.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get stable K8s releases
        id: get-releases
        run: |
          set -euo pipefail
          MIN_VERSION=${{ github.event.inputs.kubernetes_minor_version }}
          MIN_VERSION=${MIN_VERSION:-33}
          FORCE="${{ github.event.inputs.force }}"
          FORCE=${FORCE:-false}

          # Get stable releases >= 1.MIN_VERSION where version file exists
          MATRIX=$(curl -s "https://api.github.com/repos/kubernetes/kubernetes/releases?page=${{ github.event.inputs.page || 1 }}&per_page=${{ github.event.inputs.per_page || 50 }}" | \
            jq -r '.[] | select(.tag_name | test("^v[0-9]+\\.[0-9]+\\.[0-9]+$")) | .tag_name' | \
            sort -V | \
            awk -F'[.v]' -v min=$MIN_VERSION '$2==1 && $3>=min' | \
            while read version; do
              trimmed=$(echo $version | sed -E 's/\.[0-9]+$//')
              [ -f "./hack/kubernetes-${trimmed}" ] && echo "$version"
            done)

          # Filter out images that already exist (unless force=true)
          FILTERED_MATRIX=""
          for version in $MATRIX; do
            if [ "$FORCE" = "true" ]; then
              FILTERED_MATRIX="$FILTERED_MATRIX$version"$'\n'
            else
              if docker manifest inspect "ghcr.io/loft-sh/kubernetes:${version}-fips-full" > /dev/null 2>&1; then
                echo "Image ghcr.io/loft-sh/kubernetes:${version}-fips-full already exists, skipping"
              else
                FILTERED_MATRIX="$FILTERED_MATRIX$version"$'\n'
              fi
            fi
          done

          # Convert to JSON array for matrix output
          MATRIX_JSON=$(echo "$FILTERED_MATRIX" | jq -R -s -c 'split("\n") | map(select(length > 0)) | {version: .}')

          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT

  build-k8s-versions:
    needs: generate-matrix
    uses: ./.github/workflows/build-fips-for-version.yaml
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
      fail-fast: false
    with:
      k8s-version: ${{ matrix.version }}
    permissions:
      id-token: write
      packages: write
      contents: read
      attestations: write
    secrets: inherit  # Pass all secrets to the reusable workflow

