name: Kubernetes FIPS

on:
  schedule:
    # Run at 2:00 UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering
    inputs:
      page:
        description: The page number to fetch
        default: "1"
        type: string
      per_page:
        description: The number of releases per page
        default: "50"
        type: string
      force:
        description: Force the build even if the release already exists
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      kubernetes_minor_version:
        description: The minimum minor version of Kubernetes to build
        type: string

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.get-releases.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get stable K8s releases
        id: get-releases
        run: |
          set -euo pipefail
          MIN_VERSION=${{ github.event.inputs.kubernetes_minor_version }}
          MIN_VERSION=${MIN_VERSION:-33}
          FORCE="${{ github.event.inputs.force }}"
          FORCE=${FORCE:-false}

          # Get stable releases >= 1.MIN_VERSION where version file exists
          MATRIX=$(curl -s "https://api.github.com/repos/kubernetes/kubernetes/releases?page=${{ github.event.inputs.page || 1 }}&per_page=${{ github.event.inputs.per_page || 50 }}" | \
            jq -r '.[] | select(.tag_name | test("^v[0-9]+\\.[0-9]+\\.[0-9]+$")) | .tag_name' | \
            sort -V | \
            awk -F'[.v]' -v min=$MIN_VERSION '$2==1 && $3>=min' | \
            while read version; do
              trimmed=$(echo $version | sed -E 's/\.[0-9]+$//')
              [ -f "./hack/kubernetes-${trimmed}" ] && echo "$version"
            done)

          # Filter out images that already exist (unless force=true)
          FILTERED_MATRIX=""
          for version in $MATRIX; do
            if [ "$FORCE" = "true" ]; then
              FILTERED_MATRIX="$FILTERED_MATRIX$version"$'\n'
            else
              if docker manifest inspect "ghcr.io/loft-sh/kubernetes:${version}-fips-full" > /dev/null 2>&1; then
                echo "Image ghcr.io/loft-sh/kubernetes:${version}-fips-full already exists, skipping"
              else
                FILTERED_MATRIX="$FILTERED_MATRIX$version"$'\n'
              fi
            fi
          done

          # Convert to JSON array for matrix output
          MATRIX_JSON=$(echo "$FILTERED_MATRIX" | jq -R -s -c 'split("\n") | map(select(length > 0)) | {version: .}')

          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT

  build-k8s-versions:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build kubernetes FIPS ${{ matrix.version }}
        run: |
          # Setup GitHub CLI
          gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"
          
          FORCE="${{ github.event.inputs.force }}"

          cd fips

          VERSION=${{ matrix.version }}
          KUBERNETES_VERSION_TRIMMED=$(echo ${VERSION} | sed -E 's/^(v[0-9]+\.[0-9]+)\.[0-9]+$/\1/')
          
          echo "Building FIPS release for Kubernetes ${VERSION}.."
      
          # Download for amd64 and arm64
          ./build-fips.sh --target-arch amd64 --kubernetes-version ${VERSION} --versions-file "../hack/kubernetes-${KUBERNETES_VERSION_TRIMMED}"       
          ./build-fips.sh --target-arch arm64 --kubernetes-version ${VERSION} --versions-file "../hack/kubernetes-${KUBERNETES_VERSION_TRIMMED}"
      
          # Create a new release with the archives as assets
          if gh release view $VERSION --repo ${{ github.repository }} &>/dev/null; then
            gh release upload "$VERSION" \
              "./kubernetes-$VERSION-amd64-fips.tar.gz" \
              "./kubernetes-$VERSION-arm64-fips.tar.gz" \
              "./kubernetes-$VERSION-amd64-fips-full.tar.gz" \
              "./kubernetes-$VERSION-arm64-fips-full.tar.gz" \
              --repo ${{ github.repository }} \
              --clobber

            echo "Updated release for Kubernetes $VERSION"
          else
            echo "Release $VERSION does not exist"
            exit 1
          fi

          # Remove the full archives
          rm -f "./kubernetes-$VERSION-amd64-fips-full.tar.gz"
          rm -f "./kubernetes-$VERSION-arm64-fips-full.tar.gz"

          # Remove the node archives
          rm -f "./kubernetes-*.tar.gz"

      - name: Read build args
        id: build-args
        run: |
          echo "args<<EOF" >> $GITHUB_OUTPUT
          cat ./fips/build-args.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build and push k8s full image
        id: pushfull
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64,linux/arm64
          push: true
          file: ./fips/Dockerfile.full
          sbom: true
          provenance: true
          tags: ghcr.io/loft-sh/kubernetes:${{ matrix.version }}-fips-full
          build-args: |
            ${{ steps.build-args.outputs.args }}

      - name: Attest k8s full image
        uses: actions/attest-build-provenance@v2
        id: attestfull
        with:
          subject-name: ghcr.io/loft-sh/kubernetes
          subject-digest: ${{ steps.pushfull.outputs.digest }}
          push-to-registry: true

      - name: Build and push k8s image
        id: push
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64,linux/arm64
          context: ./fips
          push: true
          sbom: true
          provenance: true
          tags: ghcr.io/loft-sh/kubernetes:${{ matrix.version }}-fips
          build-args: |
            KUBERNETES_VERSION=${{ matrix.version }}

      - name: Attest k8s image
        uses: actions/attest-build-provenance@v2
        id: attest
        with:
          subject-name: ghcr.io/loft-sh/kubernetes
          subject-digest: ${{ steps.push.outputs.digest }}
          push-to-registry: true
